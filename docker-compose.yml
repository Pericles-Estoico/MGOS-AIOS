version: '3.8'

services:
  # Redis - Job queue and cache (Story 4.1)
  redis:
    image: redis:7-alpine
    container_name: mgos-redis-dev
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
    environment:
      REDIS_PASSWORD: ''
    command:
      - redis-server
      - --appendonly
      - 'yes'
      - --appendfsync
      - 'everysec'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - mgos-network
    restart: unless-stopped
    labels:
      - 'com.example.description=Redis for MGOS job queue and caching'

  mgos-aios:
    build: .
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-QGh1cjJkM3d1aHg4aXowOWo1azZsMm5wOHE=}
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-https://ytywuiyzulkvzsqfeghh.supabase.co}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-sb_publishable_Aw6RWq8GR5CROWhqvN27Mw_4FlRydm3}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-sb_secret_kgzhoRBCq9WIZbimNPaPfQ_Pq-53q0O}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - mgos-network

volumes:
  redis-data:
    driver: local

networks:
  mgos-network:
    driver: bridge
