# Story 4.3: Implement Circuit Breaker Pattern

**Epic:** Marketplace Resilience System v2
**ID:** STORY-4.3
**Status:** Draft
**Complexity:** M (8 points)
**Time Estimate:** 3-4 days

---

## Story

Implement circuit breaker to prevent cascading failures when agents are timing out or returning errors. Stops trying to call failing agents and uses fallback instead.

**Dependencies:** Story 4.1 (Redis infrastructure)

---

## Acceptance Criteria

1. ✅ Circuit breaker states: CLOSED → OPEN → HALF_OPEN → CLOSED
2. ✅ Failure threshold: 5 consecutive errors
3. ✅ Success threshold for recovery: 2 successful calls
4. ✅ Timeout duration: 60s (configurable)
5. ✅ Per-agent tracking (separate circuit for each marketplace agent)
6. ✅ Fallback to cached results or empty analysis when circuit OPEN
7. ✅ Metrics exported: state transitions, error rates, recovery time
8. ✅ Recovers gracefully when agent comes back online

---

## Scope

### IN (What we're doing)
- Generic circuit breaker implementation
- Per-agent circuit breaker instances
- State machine (CLOSED, OPEN, HALF_OPEN)
- Fallback mechanism (cached results or empty analysis)
- Metrics tracking (state, transitions, recovery time)
- Integration with existing agent calling code

### OUT (What we're NOT doing)
- Advanced circuit breaker patterns (adaptive thresholds)
- Circuit breaker persistence (state resets on restart is OK)
- Distributed circuit breaker coordination
- Circuit breaker dashboard (covered in Phase 3)

---

## Implementation Tasks

- [ ] Create `lib/resilience/circuit-breaker.ts`
  - Generic circuit breaker class
  - Configurable thresholds
  - State machine implementation
  - Time tracking for HALF_OPEN state
- [ ] Create `lib/resilience/agent-circuit-breaker.ts`
  - Agent-specific circuit breaker instances
  - Track per-agent state
  - Initialize for each marketplace agent (amazon, mercadolivre, shopee, shein, tiktok-shop)
- [ ] Update `callAgent()` function in agent-loop.ts
  - Wrap agent calls with circuit breaker
  - Fall back to empty analysis if circuit OPEN
  - Log circuit state transitions
- [ ] Update diagnostics endpoint (`GET /api/marketplace/diagnostics`)
  - Add circuit breaker status per agent
  - Show recovery time remaining
  - Recommend when to retry
- [ ] Create unit tests for all circuit breaker states
- [ ] Create integration tests with mock failing agents
- [ ] Update story File List

---

## Acceptance Test

```javascript
// Simulate 5 agent failures
for (let i = 0; i < 5; i++) {
  await callAgent('amazon', { /* will fail */ });
}
// Circuit should be OPEN now
const status = await getCircuitBreakerStatus('amazon');
// Expected: status.state === 'OPEN'

// Next call should fail fast without calling agent
const t0 = Date.now();
const result = await callAgent('amazon', { /* will fail */ });
const elapsed = Date.now() - t0;
// Expected: elapsed < 100ms (immediate rejection), result.fallback === true

// After 60s timeout, circuit enters HALF_OPEN
// Next 2 successful calls recover to CLOSED state
```

---

## Dev Notes

**Implementation considerations:**
- Track consecutive errors (not total errors)
- State transitions: CLOSED → OPEN (threshold), OPEN → HALF_OPEN (timeout), HALF_OPEN → CLOSED (success) or OPEN (failure)
- Failure threshold: 5 consecutive errors
- Success threshold for HALF_OPEN: 2 successful calls
- Timeout: 60 seconds in OPEN state before transitioning to HALF_OPEN
- Per-agent state tracking (use agent ID as key)
- Fallback should return empty analysis: `{ phases: [] }` if no cached data

**Testing approach:**
- Unit tests for all state transitions
- Mock agent to control success/failure
- Test timeout behavior
- Test recovery from HALF_OPEN
- Test fallback mechanism

**Performance targets:**
- State check: < 1ms
- Fallback response: < 10ms
- Metrics export: < 50ms

---

## Testing

**Manual Testing:**
1. Trigger agent failures to open circuit
2. Verify diagnostics endpoint shows OPEN state
3. Verify requests fail fast without calling agent
4. Wait 60 seconds and verify transition to HALF_OPEN
5. Trigger successful calls to recover to CLOSED
6. Verify normal operation resumes

**Automated Testing:**
- State machine transitions
- Error counting logic
- Timeout handling
- Success counting in HALF_OPEN
- Fallback response generation
- Per-agent isolation

---

## File List

*After implementation, list all files created/modified:*

- [ ] lib/resilience/circuit-breaker.ts
- [ ] lib/resilience/agent-circuit-breaker.ts
- [ ] app/lib/ai/agent-loop.ts (modified)
- [ ] app/api/marketplace/diagnostics/route.ts (modified)
- [ ] __tests__/resilience/circuit-breaker.test.ts
- [ ] __tests__/resilience/agent-circuit-breaker.test.ts

---

## Dev Agent Record

**Status:** Pending
**Assigned To:** @dev (Dex)
**Current Task:** Waiting for Story 4.1 completion

### Implementation Checkboxes
- [ ] Circuit breaker class created
- [ ] State machine working
- [ ] Per-agent tracking functional
- [ ] Fallback mechanism implemented
- [ ] Agent calling code integrated
- [ ] Diagnostics endpoint updated
- [ ] Unit tests passing
- [ ] Integration tests passing
- [ ] Ready for QA review

### Debug Log
(Will be updated during implementation)

### Completion Notes
(Will be added when story completes)

---

## QA Results

(Will be populated by @qa Quinn)

---

## Change Log

- Created: 2026-02-23 (Marathon Phase 2)
- Status: Draft → Ready (pending @po validation)

---

## Story Metrics

| Metric | Value |
|--------|-------|
| Story Points | 8 |
| Time Estimate | 3-4 days |
| Complexity | Medium |
| Priority | High (prevents cascading failures) |
| Risk | Medium (integration with agent-loop) |
