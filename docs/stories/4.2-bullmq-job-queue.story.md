# Story 4.2: Implement BullMQ Job Queue

**Epic:** Marketplace Resilience System v2
**ID:** STORY-4.2
**Status:** Draft
**Complexity:** L (13 points)
**Time Estimate:** 5-6 days

---

## Story

Implement BullMQ as the job queue system for Phase 1 task creation. This replaces synchronous function calls with asynchronous, reliable job processing with automatic retries.

**Dependencies:** Story 4.1 (Redis infrastructure)

---

## Acceptance Criteria

1. ✅ BullMQ queue created: `phase1-tasks`
2. ✅ Job schema defined with typed validation
3. ✅ Retry logic: exponential backoff (1s → 5s → 30s)
4. ✅ Max retries: 3 (configurable via .env)
5. ✅ Failed jobs moved to dead-letter queue
6. ✅ Job progress tracking (states: pending → active → completed)
7. ✅ Event emission (job:enqueued, job:active, job:completed, job:failed)
8. ✅ Worker process handles jobs with timeout (10s per job)
9. ✅ Graceful shutdown: wait for in-flight jobs to complete
10. ✅ Integration with existing approval flow (backward compatible)

---

## Scope

### IN (What we're doing)
- BullMQ queue setup with Redis backend
- Job type definition and validation
- Worker process implementation
- Event system for job lifecycle
- Polling endpoint for job status
- Dead-letter queue handling
- Integration tests for happy path and error cases
- Backward compatibility with existing approval flow

### OUT (What we're NOT doing)
- Message queues (Kafka, RabbitMQ)
- Distributed job tracing beyond basic logging
- Job prioritization (uniform queue)
- Scheduled jobs (Phase 4)

---

## Implementation Tasks

- [ ] Install `bullmq` and `@types/bullmq`
- [ ] Create `lib/queue/phase1-queue.ts`
  - Queue initialization with Redis client
  - Job type definition with Zod validation
  - Enqueue function with metadata
- [ ] Create `lib/queue/phase1-worker.ts`
  - Worker implementation that processes Phase 1 jobs
  - Calls existing `createPhase1Tasks()` function
  - Error handling + logging
- [ ] Create `lib/queue/queue-events.ts`
  - Event emitter for job status changes
  - Webhook notifications on completion/failure
- [ ] Update `PATCH /api/marketplace/analysis/[id]` route
  - Replace synchronous `createPhase1Tasks()` with queue enqueue
  - Return 202 Accepted with job ID
  - Implement polling endpoint: `GET /api/marketplace/jobs/{jobId}`
- [ ] Create `GET /api/marketplace/jobs/{jobId}` endpoint
  - Returns job status, progress, and result
  - 404 if job not found
- [ ] Add worker startup to app initialization
  - Worker runs in separate process or thread pool
  - Auto-reconnect on failure
- [ ] Create database migration for `marketplace_job_executions` table
- [ ] Write unit tests for queue operations
- [ ] Write integration tests for end-to-end flow
- [ ] Update story File List

---

## Database Schema Changes

```sql
-- Track job execution for audit trail
CREATE TABLE marketplace_job_executions (
  id UUID PRIMARY KEY,
  plan_id UUID NOT NULL REFERENCES marketplace_plans(id),
  job_id VARCHAR(255) NOT NULL UNIQUE,
  status VARCHAR(50) NOT NULL, -- pending, active, completed, failed
  error_message TEXT,
  attempt_number INT DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  result JSONB
);

CREATE INDEX idx_plan_id_job ON marketplace_job_executions(plan_id);
CREATE INDEX idx_status ON marketplace_job_executions(status);
```

---

## Acceptance Test

```javascript
// Test enqueue workflow
const planId = 'test-plan-123';
const response = await fetch(`/api/marketplace/analysis/${planId}`, {
  method: 'PATCH',
  body: JSON.stringify({ action: 'approve' })
});
// Expected: 202 Accepted
const { jobId } = await response.json();

// Poll for completion
let status = 'pending';
while (status !== 'completed') {
  await new Promise(r => setTimeout(r, 500));
  const jobResponse = await fetch(`/api/marketplace/jobs/${jobId}`);
  const job = await jobResponse.json();
  status = job.status;
}
// Expected: status === 'completed', tasks created
```

---

## Dev Notes

**Implementation considerations:**
- Use Zod for job payload validation
- Worker should run in separate process via `worker_threads` or child_process
- Max 3 retries with exponential backoff (1s, 5s, 30s)
- Job timeout should be 10 seconds (configurable via .env)
- Graceful shutdown should wait for active jobs (max 30s timeout)

**Testing approach:**
- Mock Redis for unit tests
- Use real Redis in integration tests
- Test retry logic with simulated failures
- Test timeout handling
- Test graceful shutdown

**Performance targets:**
- Job enqueue: < 100ms
- Job completion: < 5 seconds (P95)
- Worker startup: < 500ms
- Job status polling: < 50ms response time

---

## Testing

**Manual Testing:**
1. Start dev server with worker
2. Trigger analysis approval
3. Observe job status via polling endpoint
4. Check database for job execution record
5. Verify Phase 1 tasks are created

**Automated Testing:**
- Queue creation and initialization
- Job enqueue and dequeue
- Worker job processing
- Retry logic with exponential backoff
- Dead-letter queue handling
- Graceful shutdown with in-flight jobs
- Error handling for validation failures

---

## File List

*After implementation, list all files created/modified:*

- [ ] lib/queue/phase1-queue.ts
- [ ] lib/queue/phase1-worker.ts
- [ ] lib/queue/queue-events.ts
- [ ] app/api/marketplace/jobs/[jobId]/route.ts
- [ ] app/api/marketplace/analysis/[id]/route.ts (modified)
- [ ] supabase/migrations/TIMESTAMP_marketplace_job_executions.sql
- [ ] __tests__/queue/phase1-queue.test.ts
- [ ] __tests__/queue/phase1-worker.test.ts
- [ ] __tests__/api/marketplace/jobs.test.ts

---

## Dev Agent Record

**Status:** Pending
**Assigned To:** @dev (Dex)
**Current Task:** Waiting for Story 4.1 completion

### Implementation Checkboxes
- [ ] BullMQ queue created
- [ ] Worker process implemented
- [ ] Event system functional
- [ ] API endpoints working
- [ ] Database schema migrated
- [ ] Unit tests passing
- [ ] Integration tests passing
- [ ] Backward compatibility verified
- [ ] Ready for QA review

### Debug Log
(Will be updated during implementation)

### Completion Notes
(Will be added when story completes)

---

## QA Results

(Will be populated by @qa Quinn)

---

## Change Log

- Created: 2026-02-23 (Marathon Phase 2)
- Status: Draft → Ready (pending @po validation)

---

## Story Metrics

| Metric | Value |
|--------|-------|
| Story Points | 13 |
| Time Estimate | 5-6 days |
| Complexity | Large |
| Priority | High (core reliability feature) |
| Risk | Medium (large surface area) |
