# Story 3.2 - Implement User Management System - Phase 2

**Epic:** Epic 3 - Email Notifications & User Management System
**Story ID:** STORY-3.2
**Status:** Ready
**Priority:** P0 - Critical Path
**Timeline:** 3 Mar - 10 Mar (7 days)
**Complexity:** 10 story points

---

## ğŸ“‹ Overview

Implementar o sistema de gerenciamento de usuÃ¡rios como fase 2 do Epic 3, permitindo que usuÃ¡rios configurem suas preferÃªncias de notificaÃ§Ã£o, gerenciem perfil e controle granular sobre quais tipos de notificaÃ§Ãµes desejam receber.

**Business Value:** UsuÃ¡rios tÃªm controle total sobre notificaÃ§Ãµes, reduz spam de email, melhora experiÃªncia do usuÃ¡rio com preferÃªncias personalizadas.

---

## ğŸ¯ Acceptance Criteria

### Given
- Sistema de notificaÃ§Ã£o (Story 3.1) jÃ¡ implementado
- Database com tabela `notification_preferences` existente
- ServiÃ§o de email funcionando
- UsuÃ¡rios autenticados no sistema

### When
- UsuÃ¡rio acessa pÃ¡gina de preferÃªncias de notificaÃ§Ã£o
- UsuÃ¡rio atualiza configuraÃ§Ãµes (enable/disable tipos de notificaÃ§Ã£o)
- UsuÃ¡rio configura quiet hours (horÃ¡rio silencioso)
- Sistema processa preferÃªncias em tempo real
- UsuÃ¡rio gerencia perfil (nome, email, foto)

### Then
- PreferÃªncias sÃ£o salvas no banco de dados
- NotificaÃ§Ãµes respeitam preferÃªncias do usuÃ¡rio
- Quiet hours sÃ£o respeitadas (no sending between X-Y)
- UI estÃ¡ responsiva e intuitiva
- MudanÃ§as sÃ£o aplicadas imediatamente
- UsuÃ¡rios veem status das preferÃªncias em tempo real

---

## ğŸ“Œ Scope

### IN Scope
- [ ] Design UI para Notification Preferences page
- [ ] Create settings/notifications route (GET/POST)
- [ ] Implement preference toggles (per notification type):
  - Task assigned
  - Status changed
  - Comment mention
  - Deadline approaching
  - Daily digest
- [ ] Implement quiet hours configuration (time range picker)
  - Start time (HH:MM)
  - End time (HH:MM)
  - Timezone selection
- [ ] Create user profile management page
  - Display name
  - Email (read-only)
  - Avatar/photo upload
  - Account settings
- [ ] Implement preference enforcement in email service
  - Check preferences before sending
  - Respect quiet hours
  - Skip if preference disabled
- [ ] Create settings sidebar navigation
  - Link to notification preferences
  - Link to profile settings
  - Link to account security
- [ ] Add preference reset/restore defaults button
- [ ] Implement last modified timestamp tracking
- [ ] Add loading states and success messages
- [ ] Create responsive design for mobile/tablet

### OUT of Scope
- Two-factor authentication (Phase 3+)
- OAuth social login (Phase 3+)
- Advanced privacy settings (Phase 3+)
- Email digest creation (Phase 3)
- Preference templates/presets UI
- Notification history viewing
- Export preferences data

---

## ğŸ”— Dependencies

**Must be completed first:**
- [x] Story 3.1 (Email Notification System)
- [x] Database: notification_preferences table exists
- [x] Email service: queueEmail() function
- [ ] Design system: UI components available

**Blocks:**
- Story 3.3 (Slack integration) - pode trabalhar em paralelo
- Story 3.4 (Analytics) - depende de user preferences

---

## ğŸ“Š Acceptance Details

### Database Schema Extensions

```sql
-- Extend notification_preferences table with additional tracking
ALTER TABLE notification_preferences ADD COLUMN IF NOT EXISTS
  last_modified_by VARCHAR(100),
  last_modified_at TIMESTAMPTZ DEFAULT NOW(),
  preference_version INT DEFAULT 1,
  is_active BOOLEAN DEFAULT true;

-- Create audit log for preference changes
CREATE TABLE IF NOT EXISTS preference_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  preference_key VARCHAR(100),
  old_value TEXT,
  new_value TEXT,
  changed_at TIMESTAMPTZ DEFAULT NOW(),
  changed_by VARCHAR(100)
);
```

### User Profile Schema

```sql
-- User profiles table
CREATE TABLE IF NOT EXISTS user_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name VARCHAR(255),
  avatar_url TEXT,
  bio TEXT,
  timezone VARCHAR(50) DEFAULT 'UTC',
  language VARCHAR(5) DEFAULT 'pt-BR',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS policies for user_profiles
CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);
```

### API Routes

```typescript
// GET /api/user/preferences
- Return user's notification preferences
- Return user's profile info
- Return timezone list
- Return notification type definitions

// POST /api/user/preferences
- Update notification preferences
- Validate quiet hours format
- Track changes in audit log
- Return updated preferences

// GET /api/user/profile
- Return user profile
- Return avatar URL
- Return user metadata

// PUT /api/user/profile
- Update display name, avatar
- Update timezone, language
- Validate inputs
- Return updated profile
```

### UI Components Required

```
NotificationPreferences Component:
â”œâ”€â”€ PreferenceToggle (per notification type)
â”œâ”€â”€ QuietHoursConfig
â”‚   â”œâ”€â”€ TimeRangePicker
â”‚   â””â”€â”€ TimezoneSelector
â”œâ”€â”€ PreferenceActions
â”‚   â”œâ”€â”€ ResetDefaults button
â”‚   â””â”€â”€ SaveButton
â””â”€â”€ LastModifiedInfo

UserProfile Component:
â”œâ”€â”€ AvatarUpload
â”œâ”€â”€ DisplayNameInput
â”œâ”€â”€ EmailDisplay (read-only)
â”œâ”€â”€ TimezoneSelector
â”œâ”€â”€ LanguageSelector
â””â”€â”€ SaveButton
```

---

## ğŸ—ï¸ Architecture Notes

**Service Layer:** Create `lib/user-preferences.ts` with helper functions
- `getUserPreferences(userId): Promise<Preferences>`
- `updatePreferences(userId, updates): Promise<Preferences>`
- `checkPreferenceEnabled(userId, type): Promise<boolean>`
- `isInQuietHours(userId, timezone): Promise<boolean>`

**Integration Points:**
- Email service: Check preferences before sending
- Task service: Trigger respects preferences
- Auth service: Get current user
- Storage: Avatar upload to Supabase Storage

**UI Framework:** Next.js + React
- Server Components for initial data fetch
- Client Components for interactivity
- Form validation (zod)
- Error boundary handling

**State Management:** React hooks + Server Actions
- useState for form state
- useCallback for handlers
- Server Actions for mutations

---

## ğŸ§ª Testing Requirements

**Unit Tests:**
- [ ] Preference toggle logic
- [ ] Quiet hours calculation
- [ ] Timezone handling
- [ ] Preference validation
- [ ] Audit log tracking

**Integration Tests:**
- [ ] End-to-end preference update
- [ ] Preference enforcement in email sending
- [ ] Avatar upload
- [ ] Profile update
- [ ] Database transaction integrity

**Component Tests:**
- [ ] NotificationPreferences component
- [ ] UserProfile component
- [ ] Form validation
- [ ] Loading states
- [ ] Error messages

**Manual Testing:**
- [ ] UI responsiveness (mobile, tablet, desktop)
- [ ] Quiet hours in different timezones
- [ ] Avatar upload and display
- [ ] Preference persistence across sessions
- [ ] Preference changes affect next email

---

## ğŸ“‹ File List

**To be created:**
- [ ] `lib/user-preferences.ts` - User preference helper functions
- [ ] `app/settings/notifications/page.tsx` - Notification preferences UI
- [ ] `app/settings/profile/page.tsx` - User profile management UI
- [ ] `app/api/user/preferences/route.ts` - Preferences API
- [ ] `app/api/user/profile/route.ts` - Profile API
- [ ] `components/NotificationPreferences.tsx` - Notification prefs component
- [ ] `components/UserProfile.tsx` - Profile component
- [ ] `supabase/migrations/20260305_user_profiles_and_audit.sql` - DB schema
- [ ] `tests/lib/user-preferences.test.ts` - Unit tests
- [ ] `tests/api/user.test.ts` - API tests
- [ ] `tests/components/notification-preferences.test.tsx` - Component tests

---

## ğŸ”„ Development Workflow

**Phase Structure (for @dev):**
1. Setup user profiles table and migrations
2. Create preference helper functions
3. Build notification preferences UI component
4. Create profile management UI
5. Implement API routes (preferences + profile)
6. Integrate preference checking into email service
7. Add form validation and error handling
8. Write comprehensive tests
9. Quality gate review

---

## ğŸ¯ Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests: > 80% coverage
- [ ] Integration tests passing
- [ ] Component tests passing
- [ ] Manual testing completed
- [ ] Code review approved
- [ ] No CRITICAL ESLint issues
- [ ] TypeScript typecheck passing
- [ ] Database migrations committed
- [ ] API documentation updated
- [ ] UI responsive on all screen sizes
- [ ] Preference enforcement verified

---

## ğŸ‘¥ Team Assignment

**Scrum Master (@sm):** River - Story creation & coordination
**Developer (@dev):** Dex - Implementation
**QA (@qa):** Quinn - Quality assurance
**DevOps (@devops):** Gage - Deployment & infrastructure

---

## ğŸ“ Change Log

**2026-02-20 - Story Validated (PO Approval)** âœ…
- PO validation checklist: 95/100 (EXCELLENT)
- All 10 quality points verified
- Score breakdown: 9 points perfect (10/10), 1 point minor (7/10)
- Minor gap: Add Risk & Mitigations section (recommended but not blocker)
- Status: Draft â†’ Ready
- Approved by @po (Pax) for development

**2026-02-20 - Story Created**
- Initial story creation for Epic 3 Phase 2
- User management scope defined
- Acceptance criteria and testing requirements set
- Database schema requirements documented
- Status: Draft

---

## ğŸš€ Next Steps

1. â³ Story validation by @po
2. â³ Development by @dev
3. â³ QA review by @qa
4. â³ Push by @devops

---
