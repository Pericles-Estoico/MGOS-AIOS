# Story 3.6 - Analytics Data Aggregation - Phase 2

**Epic:** Epic 3 - Email Notifications & User Management System
**Story ID:** STORY-3.6
**Status:** Ready for Review
**Priority:** P1 - High Value Feature
**Timeline:** 3 dias (Week 3)
**Complexity:** 8 story points

---

## üìã Overview

Implementar agrega√ß√£o de dados anal√≠ticos para criar dashboards de visibilidade de produtividade da equipe. Extrair e computar m√©tricas do audit log existente para lideran√ßa tomar decis√µes baseadas em dados.

**Business Value:** Lideran√ßa tem visibilidade de produtividade da equipe, identifica gargalos, mede sucesso.

---

## üéØ Acceptance Criteria

### Given
- Sistema de task management (Epic 2) em produ√ß√£o
- Audit logs com hist√≥rico completo de execu√ß√£o
- Usu√°rios com diferentes roles (executor, QA, head, admin)
- Tasks com status: created, started, submitted, approved, rejected

### When
- Admin acessa dashboard de analytics
- Seleciona per√≠odo (7, 30 dias ou customizado)
- Sistema computar dados do banco
- API retorna m√©tricas agregadas

### Then
- API `/api/analytics/metrics` retorna:
  - Tasks completadas por membro (count, dura√ß√£o m√©dia)
  - Tempo m√©dio de conclus√£o (min/max/avg)
  - Turnaround de review do QA (min/max/avg em horas)
  - Burndown trends (tasks/dia)
  - Taxa de sucesso (% aprovadas vs rejeitadas)
  - Data points com timestamps
- Dados s√£o precisos e eficientes
- Performance < 2s para 30 dias de dados

---

## üìå Scope

### IN Scope
- [x] Create analytics schema/tables (if needed for aggregations)
- [x] Implement `/api/analytics/metrics` endpoint (GET)
- [x] Query audit logs to extract task completion data
- [x] Calculate per-user metrics (tasks completed, avg time)
- [x] Calculate team metrics (burndown trends, success rate)
- [x] Calculate QA metrics (review turnaround, approval rates)
- [x] Add date range filtering (7, 30 days, custom)
- [x] Optimize queries for performance
- [x] Add caching for metrics (optional - if performance needed)
- [x] Create seed data for testing (sample analytics)
- [x] Add API documentation

### OUT of Scope
- Dashboard UI (Story 3.7)
- Email reports (future)
- Real-time streaming analytics
- Custom report builder
- Data export (future)
- Machine learning predictions

---

## üîó Dependencies

**Must be completed first:**
- [x] Epic 2: Task management system complete
- [x] Story 3.2: User Management (for user context)
- [x] Audit log system (exists from Epic 2)

**Blocks:**
- Story 3.7 (Analytics Dashboard UI) - depends on this API

---

## üìä Data Requirements

### Metrics to Compute

```
Per-User Metrics:
- taskCount: Total tasks completed
- avgCompletionTime: Average duration from created to approved (hours)
- totalHours: Sum of all task durations
- approvalRate: % of tasks approved (approved / submitted)
- rejectionRate: % of tasks rejected
- lastCompleted: Date of most recent completed task

Team Metrics (Time Period):
- totalTasks: Tasks completed in period
- avgDailyCompletion: Tasks per day
- burndownTrend: Array of {date, tasksCompleted}
- teamAvgTime: Average completion time across all users
- overallSuccessRate: % approved across all tasks

QA Metrics:
- avgReviewTime: From submitted to approved/rejected (hours)
- pendingReviews: Count of submitted waiting review
- reviewSLA: % reviews completed < 24h
```

### Data Sources
- `audit_logs` table (from Epic 2)
- Task status transitions (created ‚Üí started ‚Üí submitted ‚Üí approved/rejected)
- User assignments
- Timestamps for all transitions

---

## üèóÔ∏è Architecture Notes

**API Layer:** Create new route `/api/analytics/metrics`
```typescript
GET /api/analytics/metrics?days=30&userId=xyz
Returns: {
  period: { start, end },
  perUserMetrics: [...],
  teamMetrics: { ... },
  qaMetrics: { ... }
}
```

**Query Optimization:**
- Index on audit_logs(task_id, user_id, created_at, status)
- Consider materialized view if queries > 5s
- Add query result caching (5 min TTL)

**Authorization:**
- Only admin/head can access team metrics
- Users can only access their own metrics
- RLS on audit_logs view

---

## üß™ Testing Requirements

**Unit Tests:**
- [x] Metric calculation functions (per-user, team, QA)
- [x] Date range filtering
- [x] Data edge cases (no tasks, single task, etc)
- [x] Authorization checks

**Integration Tests:**
- [x] Full API call with sample data
- [x] Metrics accuracy (spot check results)
- [x] Performance with 1000+ tasks
- [x] Different date ranges

**Manual Testing:**
- [x] Verify metrics against manual calculation
- [x] Test with different user roles
- [x] Check performance < 2s
- [x] Test edge cases (new user, no tasks)

---

## üìã File List

**Created:**
- [x] `lib/analytics-service.ts` - Analytics computation logic (408 lines)
- [x] `app/api/analytics/metrics/route.ts` - API endpoint (215 lines)
- [x] `supabase/migrations/20260305_analytics_schema.sql` - Indexes/views (274 lines)
- [x] `tests/lib/analytics-service.test.ts` - Unit tests (280 lines, 28 tests)
- [x] `tests/api/analytics.test.ts` - Integration tests (330 lines, 28 tests)
- [x] `docs/api/analytics.md` - API documentation (240 lines)

---

## üîÑ Development Workflow

**Phase Structure (for @dev):**
1. Design analytics schema and query strategy
2. Create analytics service with metric calculations
3. Implement API endpoint with authorization
4. Add query optimization and caching
5. Create comprehensive tests
6. Add API documentation
7. Quality gate review

---

## üéØ Definition of Done

- [x] All acceptance criteria met
- [x] API returns correct metrics
- [x] Performance < 2s for 30 days (via in-memory cache + SQL aggregations)
- [x] Unit tests > 80% coverage (28/28 tests passing)
- [x] Integration tests passing (28/28 tests passing)
- [x] Authorization validated (admin/head/user role checks)
- [x] No CRITICAL ESLint issues
- [x] TypeScript typecheck passing
- [x] Database indexes created (4 indexes on audit_logs)
- [x] API documentation complete (240 lines with examples)
- [x] Seed data for testing created (mock data in tests)

---

## üë• Team Assignment

**Scrum Master (@sm):** River - Story creation & coordination
**Developer (@dev):** Dex - Implementation
**QA (@qa):** Quinn - Quality assurance
**DevOps (@devops):** Gage - Deployment & infrastructure

---

## üìù Change Log

**2026-02-20 - Story Completed by @dev (Dex)**
- ‚úÖ Complete implementation: 1,747 lines of code in 6 files
- ‚úÖ Analytics service with in-memory caching (5 min TTL)
- ‚úÖ SQL RPC functions for per-user/team/QA metrics aggregation
- ‚úÖ API endpoint: GET/POST /api/analytics/metrics with full authorization
- ‚úÖ 4 database indexes for performance optimization
- ‚úÖ 56 tests created: 28 unit + 28 integration (ALL PASSING 100%)
- ‚úÖ Comprehensive API documentation (240 lines)
- Decision: Indexes + SQL aggregations + in-memory cache (Decision A+B confirmed)
- Authorization: Defense-in-depth (API-layer + RLS ready)
- Status: Ready ‚Üí Ready for Review
- Next: QA gate review by @qa (Quinn)

**2026-02-20 - Story Validated**
- ‚úÖ Validation by @po (Pax): 9.5/10 EXCELLENT
- Verdict: GO for development
- Minor observations documented (risk section, timezone clarity)
- Status: Draft ‚Üí Ready
- Assigned to: @dev (Dex) for implementation

**2026-02-20 - Story Created**
- Initial story creation from Epic 3 roadmap
- Analytics data aggregation scope defined
- Metrics and queries documented
- Status: Draft

---

## üöÄ Next Steps

1. ‚è≥ Story validation by @po
2. ‚è≥ Development by @dev
3. ‚è≥ QA review by @qa
4. ‚è≥ Push by @devops

---
