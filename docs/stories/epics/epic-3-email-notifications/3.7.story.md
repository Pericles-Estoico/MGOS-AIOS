# Story 3.7 - Analytics Dashboard UI - Phase 2

**Epic:** Epic 3 - Email Notifications & User Management System
**Story ID:** STORY-3.7
**Status:** Ready
**Priority:** P1 - High Value Feature
**Timeline:** 3 dias (Week 4)
**Complexity:** 8 story points

---

## üë§ Executor Assignment

**executor:** "@dev"
**quality_gate:** "@architect"
**quality_gate_tools:** ["coderabbit", "playwright", "jest"]

---

## üìã Overview

Criar interface React para visualizar m√©tricas de produtividade da equipe fornecidas pela API de analytics (Story 3.6). Dashboard interativo com filtros por per√≠odo, visualiza√ß√µes de dados, e acesso baseado em roles.

**Business Value:** Lideran√ßa tem interface visual intuitiva para monitorar produtividade da equipe, identificar gargalos visualmente, e tomar decis√µes estrat√©gicas baseadas em dados em tempo real.

---

## üéØ Acceptance Criteria

### Given
- API `/api/analytics/metrics` implementada e funcionando (Story 3.6 completa)
- Usu√°rios autenticados com roles (executor, QA, head, admin)
- M√©tricas dispon√≠veis: per-user, team, QA
- Sistema de autentica√ß√£o e autoriza√ß√£o funcionando

### When
- Admin/Head acessa dashboard em `/dashboard/analytics`
- Seleciona per√≠odo (7, 30 dias, ou data customizada)
- Escolhe visualiza√ß√£o (overview, por pessoa, por QA)
- Filtra por membro (se admin/head)
- Usu√°rio comum acessa dashboard

### Then
- Dashboard carrega e exibe m√©tricas em < 2s
- Per-User Metrics Card mostra:
  - Total tasks completed, avg completion time, approval rate, √∫ltima task
- Team Metrics Chart mostra:
  - Burndown trend (gr√°fico), total tasks, avg daily completion
- QA Metrics Card mostra:
  - Avg review turnaround, pending reviews, SLA compliance %
- Date Range Selector permite selecionar per√≠odo (7/30/custom)
- Filtro por membro √© aplicado (admin/head veem todos, users veem apenas si mesmos)
- Loading states mostram durante carregamento
- Error handling exibe mensagens claras em falhas
- Responsivo em mobile/tablet/desktop
- Dados atualizam ao trocar filtros em < 1s

---

## üìå Scope

### IN Scope
- [x] Create Analytics Dashboard page (`/dashboard/analytics`)
- [x] Per-User Metrics Card component
- [x] Team Metrics Chart component (burndown visualization)
- [x] QA Metrics Card component
- [x] Date Range Selector component (7, 30, custom)
- [x] Member Filter dropdown (for admin/head)
- [x] Loading states e skeletons
- [x] Error handling e error messages
- [x] Role-based view rendering (admin/head vs user)
- [x] Responsive design (mobile/tablet/desktop)
- [x] Hook for analytics API calls (useAnalyticsMetrics)
- [x] Hook for authorization checks (useUserRole)
- [x] TypeScript types for metrics
- [x] Component tests (unit tests)
- [x] Integration tests (dashboard data flow)
- [x] Component documentation / Storybook stories

### OUT of Scope
- Real-time auto-refresh (WebSocket)
- Data export to CSV/Excel
- Custom report builder
- Email reports
- Advanced charting (multiple Y-axes, custom aggregations)
- Print-to-PDF functionality
- Dark mode theming
- Internationalization (i18n)

---

## üîó Dependencies

**Must be completed first:**
- [x] Story 3.6: Analytics Data Aggregation API (provides `/api/analytics/metrics`)
- [x] Story 3.2: User Management (for user context and roles)
- [x] Authentication system (existing)

**Blocks:**
- Story 3.8+ (Analytics refinements, advanced features)

---

## üìä Data Requirements

### Analytics Metrics Structure (from Story 3.6)
```typescript
interface AnalyticsResponse {
  period: { start: string; end: string };
  perUserMetrics: {
    userId: string;
    userName: string;
    taskCount: number;
    avgCompletionTime: number; // hours
    totalHours: number;
    approvalRate: number; // 0-1
    rejectionRate: number; // 0-1
    lastCompleted: string; // ISO 8601
  }[];
  teamMetrics: {
    totalTasks: number;
    avgDailyCompletion: number;
    burndownTrend: { date: string; tasksCompleted: number }[];
    teamAvgTime: number; // hours
    overallSuccessRate: number; // 0-1
  };
  qaMetrics: {
    avgReviewTime: number; // hours
    pendingReviews: number;
    reviewSLA: number; // 0-1 (% completed < 24h)
  };
}
```

### Components' Data Props
```typescript
// PerUserMetricsCard.tsx
interface PerUserMetricsCardProps {
  metrics: PerUserMetric[];
  isLoading: boolean;
  error?: string;
}

// TeamMetricsChart.tsx
interface TeamMetricsChartProps {
  teamMetrics: TeamMetric;
  isLoading: boolean;
  error?: string;
}

// QAMetricsCard.tsx
interface QAMetricsCardProps {
  qaMetrics: QAMetric;
  isLoading: boolean;
  error?: string;
}
```

---

## üèóÔ∏è Architecture Notes

**Directory Structure:**
```
app/
‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îî‚îÄ‚îÄ analytics/
‚îÇ       ‚îú‚îÄ‚îÄ page.tsx                    # Main dashboard page
‚îÇ       ‚îú‚îÄ‚îÄ layout.tsx                  # Dashboard layout (optional)
‚îÇ       ‚îî‚îÄ‚îÄ components/
‚îÇ           ‚îú‚îÄ‚îÄ AnalyticsContainer.tsx  # Main container/orchestrator
‚îÇ           ‚îú‚îÄ‚îÄ PerUserMetricsCard.tsx  # Per-user metrics card
‚îÇ           ‚îú‚îÄ‚îÄ TeamMetricsChart.tsx    # Burndown chart
‚îÇ           ‚îú‚îÄ‚îÄ QAMetricsCard.tsx       # QA metrics card
‚îÇ           ‚îú‚îÄ‚îÄ DateRangeSelector.tsx   # Date range picker
‚îÇ           ‚îî‚îÄ‚îÄ MemberFilter.tsx        # Member selection dropdown

lib/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useAnalyticsMetrics.ts          # Hook for fetching metrics
‚îÇ   ‚îî‚îÄ‚îÄ useUserRole.ts                  # Hook for role-based rendering
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ analytics.ts                    # TypeScript types
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ analytics-formatter.ts          # Format numbers, percentages, etc

tests/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ PerUserMetricsCard.test.tsx
‚îÇ   ‚îú‚îÄ‚îÄ TeamMetricsChart.test.tsx
‚îÇ   ‚îú‚îÄ‚îÄ QAMetricsCard.test.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DateRangeSelector.test.tsx
‚îÇ   ‚îî‚îÄ‚îÄ MemberFilter.test.tsx
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ analytics-dashboard.integration.test.tsx
```

**Key Libraries:**
- **recharts** - For burndown trend chart visualization
- **react-hook-form** - For date range selector form
- **date-fns** - For date manipulation
- **clsx** - For responsive className management

**Design Patterns:**
1. **Container/Presentational:** AnalyticsContainer orchestrates data, passes to presentational components
2. **Custom Hooks:** useAnalyticsMetrics for API calls, useUserRole for authorization
3. **Error Boundaries:** Wrap dashboard sections for graceful error handling
4. **Skeleton Loading:** Show placeholder content while loading
5. **Responsive Grid:** Use Tailwind CSS grid for mobile/tablet/desktop

---

## üß™ Testing Requirements

**Unit Tests (Component Tests):**
- [ ] PerUserMetricsCard: Renders metrics correctly, formats numbers, handles empty state
- [ ] TeamMetricsChart: Renders burndown chart, handles edge cases (no data, single point)
- [ ] QAMetricsCard: Displays QA metrics, formats percentages, handles loading
- [ ] DateRangeSelector: Preset buttons work (7, 30 days), custom date picker works
- [ ] MemberFilter: Dropdown toggles, selection changes, filtering updates
- [ ] useAnalyticsMetrics: Fetches data, caches, handles errors
- [ ] useUserRole: Returns correct role, determines visibility

**Integration Tests:**
- [ ] Dashboard loads and displays all sections
- [ ] Data flows from API ‚Üí container ‚Üí components
- [ ] Date range change triggers new API call
- [ ] Member filter change triggers new API call
- [ ] Loading states show during fetch
- [ ] Error handling displays error message on API failure
- [ ] Admin/head sees all metrics, users see only their own
- [ ] Responsive breakpoints (mobile 375px, tablet 768px, desktop 1024px)

**Manual Testing:**
- [ ] Performance: Dashboard loads in < 2s on 4G
- [ ] Accessibility: Keyboard navigation works, screen reader friendly
- [ ] Cross-browser: Chrome, Firefox, Safari, Edge
- [ ] Edge cases: No tasks in period, single user, single task

---

## üìã File List

**To Create:**
- [ ] `app/dashboard/analytics/page.tsx` - Main dashboard page (150-200 lines)
- [ ] `app/dashboard/analytics/components/AnalyticsContainer.tsx` - Data orchestration (200-250 lines)
- [ ] `app/dashboard/analytics/components/PerUserMetricsCard.tsx` - Per-user metrics display (120-150 lines)
- [ ] `app/dashboard/analytics/components/TeamMetricsChart.tsx` - Burndown chart (180-220 lines)
- [ ] `app/dashboard/analytics/components/QAMetricsCard.tsx` - QA metrics display (100-130 lines)
- [ ] `app/dashboard/analytics/components/DateRangeSelector.tsx` - Date range picker (140-180 lines)
- [ ] `app/dashboard/analytics/components/MemberFilter.tsx` - Member selection (120-150 lines)
- [ ] `lib/hooks/useAnalyticsMetrics.ts` - API hook (80-120 lines)
- [ ] `lib/hooks/useUserRole.ts` - Role-based rendering hook (60-80 lines)
- [ ] `lib/types/analytics.ts` - TypeScript type definitions (100-150 lines)
- [ ] `lib/utils/analytics-formatter.ts` - Formatting utilities (80-120 lines)
- [ ] `tests/components/PerUserMetricsCard.test.tsx` - Component tests (150-180 lines)
- [ ] `tests/components/TeamMetricsChart.test.tsx` - Chart tests (120-150 lines)
- [ ] `tests/components/QAMetricsCard.test.tsx` - QA metrics tests (100-130 lines)
- [ ] `tests/components/DateRangeSelector.test.tsx` - Date picker tests (140-180 lines)
- [ ] `tests/components/MemberFilter.test.tsx` - Filter tests (120-150 lines)
- [ ] `tests/integration/analytics-dashboard.integration.test.tsx` - Integration tests (300-400 lines)
- [ ] `docs/dashboard/analytics.md` - UI documentation (200-250 lines)

**Total: ~2,600-3,300 lines of code**

---

## üîÑ Development Workflow

**Phase Structure (for @dev):**

1. **Phase 1: Setup & Types**
   - Create TypeScript types in `lib/types/analytics.ts`
   - Create formatting utilities in `lib/utils/analytics-formatter.ts`
   - Define component prop interfaces

2. **Phase 2: Hooks & API Integration**
   - Implement `useAnalyticsMetrics.ts` hook for API calls
   - Implement `useUserRole.ts` hook for role-based logic
   - Test hook data fetching and caching

3. **Phase 3: Component Development**
   - Create PerUserMetricsCard (displays per-user metrics)
   - Create TeamMetricsChart (burndown visualization with recharts)
   - Create QAMetricsCard (displays QA metrics)
   - Create DateRangeSelector (period selection)
   - Create MemberFilter (user/member selection for admin/head)

4. **Phase 4: Container & Page**
   - Create AnalyticsContainer (orchestrates data flow)
   - Create main analytics page (`/dashboard/analytics`)
   - Wire all components together

5. **Phase 5: Testing**
   - Unit tests for each component
   - Integration tests for full dashboard flow
   - Error boundary and loading state tests

6. **Phase 6: Documentation & Polish**
   - Create API documentation (`docs/dashboard/analytics.md`)
   - Add Storybook stories (optional)
   - Verify responsive design

---

## üéØ Definition of Done

- [ ] All acceptance criteria met (responsive, filters work, authorization correct)
- [ ] Dashboard loads in < 2s
- [ ] All components render correctly
- [ ] Date range selector works (7, 30, custom dates)
- [ ] Member filter works (admin/head only)
- [ ] Loading states show during fetch
- [ ] Error handling displays clear messages
- [ ] Unit tests > 80% coverage (all component tests passing)
- [ ] Integration tests passing (dashboard data flow verified)
- [ ] No CRITICAL ESLint issues
- [ ] TypeScript typecheck passing
- [ ] Mobile responsive (375px, 768px, 1024px breakpoints)
- [ ] Accessibility: Keyboard navigation + semantic HTML
- [ ] Documentation complete (API docs + component docs)
- [ ] Seed data / mock data available for testing
- [ ] Performance: API calls cached, no unnecessary re-renders

---

## üë• Team Assignment

**Scrum Master (@sm):** River - Story creation & coordination
**Developer (@dev):** Dex - Implementation
**QA (@qa):** Quinn - Quality assurance
**DevOps (@devops):** Gage - Deployment & infrastructure

---

## üîÑ CodeRabbit Integration

### Story Type Analysis

**Primary Type:** Frontend
**Secondary Type(s):** API Integration, UI/UX
**Complexity:** 8 story points (Medium)

### Specialized Agent Assignment

**Primary Agents:**
- @dev (Dex) - Full React/TypeScript development
- @qa (Quinn) - Component testing, accessibility verification

**Supporting Agents:**
- @architect (Aria) - Design pattern consultation
- @ux-design-expert - Accessibility (WCAG 2.1 AA) review

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run before marking story complete
  - Focus: Component patterns, test coverage, TypeScript types
- [ ] Pre-PR (@devops): Run before creating pull request
  - Focus: Integration safety, responsive design, backward compatibility
- [ ] Pre-Deployment (@devops): Run before production deploy
  - Focus: Performance, accessibility, security (no XSS vulnerabilities)

### Self-Healing Configuration

**Expected Self-Healing:**
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 30 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior:**
- CRITICAL issues: auto-fix (iteration < 2) else document
- HIGH issues: auto_fix if iteration < 2, else document_as_debt

### CodeRabbit Focus Areas

**Primary Focus:**
- Component patterns: Proper React hooks usage, no unnecessary re-renders
- TypeScript safety: Type safety, no `any` types, strict null checks
- Accessibility: WCAG 2.1 AA compliance (semantic HTML, ARIA, keyboard nav)

**Secondary Focus:**
- Performance: Component optimization, lazy loading where appropriate
- Testing: Unit test coverage, mock data patterns
- Responsive design: Mobile-first approach, Tailwind CSS grid usage

---

## üìù Dev Notes

### Source Tree Structure
```
Project uses Next.js app router with:
- app/api/* for backend routes
- app/dashboard/* for dashboard pages
- lib/hooks for custom React hooks
- lib/utils for utility functions
- tests/ for Jest test files
- Tailwind CSS for styling
- TypeScript with strict mode
```

### Relevant from Story 3.6 (Analytics API)

**API Endpoint:** `GET /api/analytics/metrics?days=30&userId=xyz`

**Response Structure:**
```typescript
{
  period: { start: "2026-02-20", end: "2026-03-20" },
  perUserMetrics: [
    {
      userId: "user-1",
      userName: "John Doe",
      taskCount: 25,
      avgCompletionTime: 4.5,
      totalHours: 112.5,
      approvalRate: 0.92,
      rejectionRate: 0.08,
      lastCompleted: "2026-03-20T14:30:00Z"
    }
  ],
  teamMetrics: {
    totalTasks: 150,
    avgDailyCompletion: 5.0,
    burndownTrend: [
      { date: "2026-02-20", tasksCompleted: 5 },
      { date: "2026-02-21", tasksCompleted: 6 }
    ],
    teamAvgTime: 4.2,
    overallSuccessRate: 0.88
  },
  qaMetrics: {
    avgReviewTime: 2.1,
    pendingReviews: 3,
    reviewSLA: 0.95
  }
}
```

**Authorization Rules (from Story 3.6):**
- admin/head ‚Üí full access (all users' metrics)
- user/executor ‚Üí own metrics only (filtered at service layer)
- Dashboard enforces role-based view rendering

### Styling Approach
- Tailwind CSS (existing in codebase)
- Responsive grid: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`
- Cards with shadow: `bg-white shadow-md rounded-lg p-6`
- Loading skeleton: Use `animate-pulse` for placeholders
- Charts: recharts library for burndown visualization

### Key Integration Points
1. **API Hook:** `useAnalyticsMetrics()` calls Story 3.6 endpoint
2. **Authorization:** `useUserRole()` determines what metrics to display
3. **Container Pattern:** AnalyticsContainer manages state, passes to child components
4. **Error Boundaries:** Wrap dashboard sections to handle component errors
5. **Loading States:** Show skeleton cards while fetching data

### Testing Patterns
- Jest + React Testing Library for component tests
- Mock API responses with `jest.mock()`
- Test user roles: admin, head, executor
- Test date range changes trigger new API calls
- Test member filter changes trigger filtered API calls

### Important Notes from Previous Stories
- Story 3.6 provides metrics API with full authorization checks
- Story 3.2 provides user context and role information
- Authentication system handles Bearer token validation
- RLS policies ready for implementation in database layer
- Cache TTL is 5 minutes (dashboard may show slightly stale data)

---

## üß™ Testing Standards

### Test Framework
- **Framework:** Jest + React Testing Library
- **Location:** `tests/components/` and `tests/integration/`
- **Pattern:** One test file per component, plus integration test

### Test Requirements
- Minimum 80% coverage for all components
- Unit tests for each component (render, props, state)
- Integration tests for full dashboard data flow
- Mock API responses for testing
- Test loading states and error handling
- Test role-based rendering (admin vs user views)

### Test Data
- Mock metrics response (in test fixtures)
- Mock user roles (admin, head, executor)
- Mock API delay for loading state testing

---

## ‚úÖ QA Results

**Status:** Pending (Story in Draft, awaiting development)

---

## üìù Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.1 | Story validated and marked Ready - Added executor assignment fields, 8.7/10 validation score | @po (Pax) |
| 2026-02-20 | 1.0 | Story creation from Epic 3 roadmap | @sm (River) |

---

## üöÄ Next Steps

1. ‚úÖ Story validation by @po (Pax) - **COMPLETE** (8.7/10)
2. ‚è≥ Development by @dev (Dex) - **READY TO START**
3. ‚è≥ QA review by @qa (Quinn)
4. ‚è≥ Push by @devops (Gage)

---
